# Makefile - One-Command Verification
#
# Usage:
#   make clean all          # Build container, install deps
#   make backtest YEAR=2023 # Run dev backtest
#   make holdout YEAR=2024  # Run holdout backtest
#   make report             # Render HTML summary
#   make verify             # Run all verification checks

.PHONY: clean all backtest holdout report verify test golden

# Configuration
PYTHON := python3
ARTIFACTS_DIR := artifacts
TIMESTAMP := $(shell date +%Y%m%d_%H%M%S)
RUN_DIR := $(ARTIFACTS_DIR)/$(TIMESTAMP)

# Git SHA for reproducibility
GIT_SHA := $(shell git rev-parse HEAD)
GIT_DIRTY := $(shell git diff-index --quiet HEAD -- || echo "-dirty")

# Default year for backtest
YEAR ?= 2023

#############################################################################
# Setup
#############################################################################

clean:
	@echo "üßπ Cleaning artifacts..."
	rm -rf $(ARTIFACTS_DIR)/temp
	rm -rf __pycache__ */__pycache__ */*/__pycache__
	@echo "‚úÖ Clean complete"

all: clean
	@echo "üîß Installing dependencies..."
	$(PYTHON) -m pip install -q -r requirements.txt
	@echo "‚úÖ Setup complete"

#############################################################################
# Backtesting
#############################################################################

backtest:
	@echo "=================================================="
	@echo "BACKTEST: $(YEAR)"
	@echo "Git SHA: $(GIT_SHA)$(GIT_DIRTY)"
	@echo "Timestamp: $(TIMESTAMP)"
	@echo "=================================================="
	@mkdir -p $(RUN_DIR)
	@echo "Running backtest..."
	$(PYTHON) scripts/run_backtest.py \
		--year $(YEAR) \
		--output $(RUN_DIR) \
		--seed 42 \
		--git-sha $(GIT_SHA)$(GIT_DIRTY)
	@echo "‚úÖ Backtest complete: $(RUN_DIR)"

holdout:
	@echo "=================================================="
	@echo "HOLDOUT TEST: $(YEAR)"
	@echo "Git SHA: $(GIT_SHA)$(GIT_DIRTY)"
	@echo "Timestamp: $(TIMESTAMP)"
	@echo "=================================================="
	@mkdir -p $(RUN_DIR)
	@echo "Running holdout test..."
	$(PYTHON) scripts/run_backtest.py \
		--year $(YEAR) \
		--output $(RUN_DIR) \
		--seed 42 \
		--git-sha $(GIT_SHA)$(GIT_DIRTY) \
		--holdout
	@echo "‚úÖ Holdout complete: $(RUN_DIR)"

#############################################################################
# Reporting
#############################################################################

report:
	@echo "üìä Generating report..."
	$(PYTHON) scripts/generate_report.py \
		--input $(RUN_DIR) \
		--output $(RUN_DIR)/summary.html
	@echo "‚úÖ Report generated: $(RUN_DIR)/summary.html"
	@echo ""
	@echo "View report:"
	@echo "  open $(RUN_DIR)/summary.html"

#############################################################################
# Verification Checks
#############################################################################

verify: test golden calibration rollforward
	@echo "‚úÖ All verification checks passed"

test:
	@echo "üß™ Running unit tests..."
	$(PYTHON) -m pytest tests/ \
		--cov=simulator \
		--cov-report=term-missing \
		--cov-fail-under=90
	@echo "‚úÖ Unit tests passed"

golden:
	@echo "üèÜ Running golden tests..."
	$(PYTHON) tests/test_golden.py
	@echo "‚úÖ Golden tests passed"

calibration:
	@echo "üìè Running calibration checks..."
	$(PYTHON) scripts/check_calibration.py
	@echo "‚úÖ Calibration checks passed"

rollforward:
	@echo "üîí Running roll-forward audit..."
	$(PYTHON) scripts/audit_rollforward.py
	@echo "‚úÖ Roll-forward audit passed"

#############################################################################
# Help
#############################################################################

help:
	@echo "Available targets:"
	@echo "  make clean          - Clean artifacts"
	@echo "  make all            - Install dependencies"
	@echo "  make backtest       - Run dev backtest (YEAR=2023)"
	@echo "  make holdout        - Run holdout test (YEAR=2024)"
	@echo "  make report         - Generate HTML report"
	@echo "  make verify         - Run all verification checks"
	@echo "  make test           - Run unit tests"
	@echo "  make golden         - Run golden tests"
	@echo "  make calibration    - Check calibration metrics"
	@echo "  make rollforward    - Audit roll-forward discipline"
	@echo ""
	@echo "Example workflow:"
	@echo "  make clean all"
	@echo "  make backtest YEAR=2023"
	@echo "  make report"
	@echo "  make verify"

