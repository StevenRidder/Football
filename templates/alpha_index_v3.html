{% extends "base.html" %}

{% block title %}NFL Alpha Model - Week {{ current_week }}{% endblock %}

{% block content %}
<div class="page-header d-print-none">
  <div class="container-xl">
    <div class="row g-2 align-items-center">
      <div class="col">
        <h2 class="page-title">NFL Alpha Model</h2>
        <div class="text-muted mt-1">XGBoost predictions with real-time line tracking</div>
      </div>
      <div class="col-auto ms-auto">
        <select class="form-select" id="weekSelect">
          {% for week in all_weeks %}
          <option value="{{ week }}" {% if week == current_week %}selected{% endif %}>
            Week {{ week }}{% if week == current_week %} (Current){% endif %}
          </option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>
</div>

<div class="page-body">
  <div class="container-xl">
    <!-- Performance Summary -->
    <div class="row mb-3" id="performance-summary">
      <div class="col-md-3">
        <div class="card">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="subheader">This Week</div>
            </div>
            <div class="h1 mb-0" id="week-record">-</div>
            <div class="text-muted" id="week-win-rate">-</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <a href="/model-performance" class="card card-link">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="subheader">Season Total</div>
            </div>
            <div class="h1 mb-0" id="season-record">-</div>
            <div class="text-muted" id="season-win-rate">-</div>
          </div>
        </a>
      </div>
      <div class="col-md-3">
        <div class="card">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="subheader">Week ROI</div>
            </div>
            <div class="h1 mb-0" id="week-roi">-</div>
            <div class="text-muted">Return on investment</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="subheader">Season ROI</div>
            </div>
            <div class="h1 mb-0" id="season-roi">-</div>
            <div class="text-muted">Return on investment</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Betting Recommendations Section -->
    {% if betting_recommendations %}
    <div class="card mb-3">
      <div class="card-header">
        <h3 class="card-title">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chart-line me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><polyline points="3 3 3 21 21 21" /><polyline points="7 10 12 15 17 10 21 14" /></svg>
          This Week's Best Bets - Model vs. Market Analysis
        </h3>
        <div class="text-muted small">Automated edge analysis: Simulator predictions vs. closing lines</div>
      </div>
      <div class="card-body">
        
        <!-- ATS Bets Table -->
        <div class="mb-4">
          <h4 class="mb-3">üéØ Against-the-Spread (ATS) Bets</h4>
          <div class="table-responsive">
            <table class="table table-sm table-hover table-striped">
              <thead>
                <tr>
                  <th>Game</th>
                  <th>Market Line</th>
                  <th>Sim Line</th>
                  <th>Edge</th>
                  <th>Pick</th>
                  <th>Confidence</th>
                </tr>
              </thead>
              <tbody>
                {% for bet in betting_recommendations.ats_bets %}
                <tr class="{% if bet.conviction == 'HIGH' %}table-success{% endif %}">
                  <td><strong>{{ bet.game }}</strong></td>
                  <td>{{ bet.market_line }}</td>
                  <td>{{ bet.sim_line }}</td>
                  <td>{{ bet.edge }}</td>
                  <td><span class="badge bg-primary">{{ bet.pick }}</span></td>
                  <td>
                    <span class="badge {% if bet.conviction == 'HIGH' %}bg-success{% elif bet.conviction == 'MEDIUM' %}bg-warning{% else %}bg-secondary{% endif %}">
                      {{ bet.confidence }}
                    </span>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="text-muted small">
            <strong>Top ATS plays:</strong> 
            {% for bet in betting_recommendations.recommendations.ats %}
              {{ bet.pick }}{% if not loop.last %}, {% endif %}
            {% endfor %}
          </div>
        </div>
        
        <!-- Totals Table -->
        {% if betting_recommendations.total_bets %}
        <div class="mb-4">
          <h4 class="mb-3">üìä Totals (Over/Under)</h4>
          <div class="table-responsive">
            <table class="table table-sm table-hover table-striped">
              <thead>
                <tr>
                  <th>Game</th>
                  <th>Market Total</th>
                  <th>Sim Total</th>
                  <th>Edge</th>
                  <th>Pick</th>
                  <th>Confidence</th>
                </tr>
              </thead>
              <tbody>
                {% for bet in betting_recommendations.total_bets %}
                <tr>
                  <td><strong>{{ bet.game }}</strong></td>
                  <td>{{ bet.market_total }}</td>
                  <td>{{ bet.sim_total }}</td>
                  <td>{{ bet.edge }}</td>
                  <td><span class="badge bg-info">{{ bet.pick }}</span></td>
                  <td><span class="badge bg-secondary">{{ bet.confidence }}</span></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="text-muted small">
            <strong>Top Totals:</strong> 
            {% for bet in betting_recommendations.recommendations.totals %}
              {{ bet.pick }}{% if not loop.last %}, {% endif %}
            {% endfor %}
          </div>
        </div>
        {% endif %}
        
        <!-- Moneyline Table -->
        {% if betting_recommendations.ml_picks %}
        <div class="mb-4">
          <h4 class="mb-3">üí∞ Moneyline Value</h4>
          <div class="table-responsive">
            <table class="table table-sm table-hover table-striped">
              <thead>
                <tr>
                  <th>Game</th>
                  <th>Market Projection</th>
                  <th>Sim Projection</th>
                  <th>Edge</th>
                  <th>Moneyline Pick</th>
                </tr>
              </thead>
              <tbody>
                {% for bet in betting_recommendations.ml_picks %}
                <tr>
                  <td><strong>{{ bet.game }}</strong></td>
                  <td>{{ bet.market_proj }}</td>
                  <td>{{ bet.sim_proj }}</td>
                  <td><span class="badge bg-success">{{ bet.edge }}</span></td>
                  <td><span class="badge bg-primary">{{ bet.pick }}</span></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="text-muted small">
            <strong>Top Moneyline picks:</strong> 
            {% for bet in betting_recommendations.recommendations.moneyline %}
              {{ bet.pick }}{% if not loop.last %}, {% endif %}
            {% endfor %}
          </div>
        </div>
        {% endif %}
        
        <!-- Final Recommendations Summary -->
        <div class="alert alert-success mb-0">
          <h4 class="alert-title">üèÜ Final Recommendations</h4>
          <div class="row">
            <div class="col-md-4">
              <h5>ATS</h5>
              <ul class="mb-0">
                {% for bet in betting_recommendations.recommendations.ats %}
                <li><strong>{{ bet.pick }}</strong> ({{ bet.conviction }})</li>
                {% endfor %}
              </ul>
            </div>
            <div class="col-md-4">
              <h5>Totals</h5>
              <ul class="mb-0">
                {% for bet in betting_recommendations.recommendations.totals %}
                <li><strong>{{ bet.pick }}</strong></li>
                {% endfor %}
              </ul>
            </div>
            <div class="col-md-4">
              <h5>Moneyline</h5>
              <ul class="mb-0">
                {% for bet in betting_recommendations.recommendations.moneyline %}
                <li><strong>{{ bet.pick }}</strong></li>
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
        
      </div>
    </div>
    {% endif %}
    
    <!-- Weekly Workflow -->
    <div class="card mb-3">
      <div class="card-header">
        <h3 class="card-title">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-event me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5m0 2a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2z" /><path d="M16 3l0 4" /><path d="M8 3l0 4" /><path d="M4 11l16 0" /><path d="M8 15h2v2h-2z" /></svg>
          Weekly Workflow
        </h3>
        <div class="text-muted small">Run these steps every week to generate sharp predictions</div>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <!-- Step 1: Data Prep -->
          <div class="col-md-4">
            <div class="badge bg-blue text-white mb-2 w-100">STEP 1: Tuesday AM</div>
            <button class="btn btn-primary w-100" onclick="runWeeklyDataPrep()" id="btn-weekly-prep">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-database-import me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 6m-8 0a8 3 0 1 0 16 0a8 3 0 1 0 -16 0" /><path d="M4 6v6a8 3 0 0 0 8 3" /><path d="M4 12v6a8 3 0 0 0 8 3" /><path d="M19 15v-2" /><path d="M19 21l3 -3l-3 -3" /><path d="M22 18h-9" /></svg>
              Weekly Data Prep
            </button>
            <div class="text-muted mt-1 small">Updates NFLverse stats + calibration (2-3 min)</div>
          </div>
          
          <!-- Step 2: Generate Predictions -->
          <div class="col-md-4">
            <div class="badge bg-green text-white mb-2 w-100">STEP 2: Wednesday</div>
            <button class="btn btn-success w-100" onclick="runScript('sim_week9_10')" id="btn-sim-week9-10">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brain me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M15.5 13a3.5 3.5 0 0 0 -3.5 3.5v1a3.5 3.5 0 0 0 7 0v-1.8" /><path d="M8.5 13a3.5 3.5 0 0 1 3.5 3.5v1a3.5 3.5 0 0 1 -7 0v-1.8" /><path d="M17.5 16a3.5 3.5 0 0 0 0 -7h-.5" /><path d="M19 9.3v-2.8a3.5 3.5 0 0 0 -7 0" /><path d="M6.5 16a3.5 3.5 0 0 1 0 -7h.5" /><path d="M5 9.3v-2.8a3.5 3.5 0 0 1 7 0v10" /></svg>
              Predict Next 2 Weeks
            </button>
            <div class="text-muted mt-1 small">Generates predictions for upcoming games (30 sec)</div>
          </div>
          
          <!-- Step 3: Live Scores -->
          <div class="col-md-4">
            <div class="badge bg-orange text-white mb-2 w-100">STEP 3: Game Day</div>
            <button class="btn btn-warning w-100" onclick="fetchLiveScores()" id="btn-fetch-scores">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-live-photo me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r=".5" fill="currentColor" /><circle cx="12" cy="12" r="7" /><path d="M8 8l-2.5 -2.5" /><path d="M16 8l2.5 -2.5" /><path d="M8 16l-2.5 2.5" /><path d="M16 16l2.5 2.5" /></svg>
              Fetch Live Scores
            </button>
            <div class="text-muted mt-1 small">Updates game results from ESPN (10 sec)</div>
          </div>
        </div>
        
        <!-- Utility Button -->
        <div class="row g-3 mt-2">
          <div class="col-md-12">
            <button class="btn btn-info w-100" onclick="reloadData()" id="btn-reload">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-refresh me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4" /><path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4" /></svg>
              Reload Predictions (Cache Bust)
            </button>
            <div class="text-muted mt-1 small">Refresh predictions from CSV if they don't auto-update</div>
          </div>
        </div>
        <div id="script-output" class="mt-3" style="display: none;">
          <div class="alert alert-info mb-0">
            <div class="d-flex align-items-center">
              <div class="spinner-border spinner-border-sm me-3" role="status"></div>
              <div>
                <strong id="script-status">Running...</strong>
                <div class="text-muted small" id="script-message">Please wait...</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Games List - Clean Card Layout -->
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">All Games</h3>
        <div class="card-actions">
          <div class="btn-group" role="group">
            <input type="radio" class="btn-check" name="view-mode" id="view-cards" autocomplete="off" checked>
            <label class="btn btn-sm" for="view-cards">
              <i class="ti ti-layout-grid me-1"></i>Cards
            </label>
            <input type="radio" class="btn-check" name="view-mode" id="view-table" autocomplete="off">
            <label class="btn btn-sm" for="view-table">
              <i class="ti ti-table me-1"></i>Table
            </label>
          </div>
        </div>
      </div>
      
      <!-- Card View (Default) -->
      <div class="card-body" id="games-cards">
        <div class="text-center text-muted py-4">
          <div class="spinner-border spinner-border-sm me-2" role="status"></div>
          Loading games...
        </div>
      </div>
      
      <!-- Table View (Hidden by default) -->
      <div class="table-responsive d-none" id="games-table-view">
        <table class="table table-vcenter card-table table-sm" id="games-table">
          <thead>
            <tr>
              <th data-sort="game" class="sortable">Game <i class="ti ti-selector ms-1"></i></th>
              <th data-sort="final" class="sortable">Final <i class="ti ti-selector ms-1"></i></th>
              <th data-sort="market_score" class="sortable">Market Score <i class="ti ti-selector ms-1"></i></th>
              <th data-sort="our_score" class="sortable">Our Score <i class="ti ti-selector ms-1"></i></th>
              <th data-sort="market_spread" class="sortable">Market Spread <i class="ti ti-selector ms-1"></i></th>
              <th data-sort="our_spread" class="sortable">Our Spread <i class="ti ti-selector ms-1"></i></th>
              <th data-sort="spread_bet" class="sortable">Spread Bet <i class="ti ti-selector ms-1"></i></th>
              <th data-sort="spread_result" class="col-result sortable">Result <i class="ti ti-selector ms-1"></i></th>
              <th data-sort="market_total" class="sortable">Market O/U <i class="ti ti-selector ms-1"></i></th>
              <th data-sort="our_total" class="sortable">Our O/U <i class="ti ti-selector ms-1"></i></th>
              <th data-sort="total_bet" class="sortable">Total Bet <i class="ti ti-selector ms-1"></i></th>
              <th data-sort="total_result" class="col-result sortable">Result <i class="ti ti-selector ms-1"></i></th>
              <th data-sort="ml_bet" class="sortable">ML Bet <i class="ti ti-selector ms-1"></i></th>
              <th data-sort="ml_result" class="col-result sortable">Result <i class="ti ti-selector ms-1"></i></th>
            </tr>
          </thead>
          <tbody id="games-tbody">
            <tr>
              <td colspan="14" class="text-center text-muted">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                Loading games...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<style>
/* Sortable column styling using Tabler patterns only */
th.sortable {
  cursor: pointer;
  user-select: none;
}
th.sortable:hover {
  background-color: var(--tblr-table-hover-bg);
}
th.sortable .ti-selector {
  opacity: 0.3;
  transition: opacity 0.2s;
}
th.sortable:hover .ti-selector {
  opacity: 0.6;
}
th.sortable.sort-asc .ti-selector::before {
  content: "\ea12"; /* ti-chevron-up */
  opacity: 1;
}
th.sortable.sort-desc .ti-selector::before {
  content: "\ea13"; /* ti-chevron-down */
  opacity: 1;
}
</style>

<script>
async function loadGames() {
  const week = document.getElementById('weekSelect').value;
  
  try {
    // Try simulator predictions first, fall back to regular predictions
    let res = await fetch(`/api/simulator-predictions?week=${week}`);
    if (!res.ok || res.status === 404) {
      res = await fetch(`/api/games/graded?week=${week}`);
    }
    
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    
    const data = await res.json();
    currentGamesData = data.games || [];
    teamWinRates = data.team_win_rates || {}; // Store team performance data
    renderGames(currentGamesData);
    setupTableSorting();
    await updatePerformanceStats(parseInt(week));
  } catch (err) {
    document.getElementById('games-tbody').innerHTML = `
      <tr><td colspan="14" class="text-center text-danger">
        <i class="ti ti-alert-circle me-2"></i>Error: ${err.message}
      </td></tr>
    `;
  }
}

async function updatePerformanceStats(currentWeek) {
  try {
    // Load all weeks up to current week to calculate season stats
    const weekPromises = [];
    for (let w = 1; w <= currentWeek; w++) {
      weekPromises.push(fetch(`/api/games/graded?week=${w}`).then(r => r.json()));
    }
    
    const allWeeksData = await Promise.all(weekPromises);
    
    // Calculate current week stats
    const currentWeekGames = allWeeksData[currentWeek - 1].games.filter(g => g.is_completed);
    const weekStats = calculateStats(currentWeekGames);
    
    // Calculate season stats (all weeks)
    const allGames = allWeeksData.flatMap(w => w.games).filter(g => g.is_completed);
    const seasonStats = calculateStats(allGames);
    
    // Update UI
    document.getElementById('week-record').textContent = `${weekStats.wins}-${weekStats.losses}`;
    document.getElementById('week-win-rate').textContent = `${weekStats.winRate}% win rate`;
    document.getElementById('week-roi').textContent = `${weekStats.roi > 0 ? '+' : ''}${weekStats.roi}%`;
    
    document.getElementById('season-record').textContent = `${seasonStats.wins}-${seasonStats.losses}`;
    document.getElementById('season-win-rate').textContent = `${seasonStats.winRate}% win rate`;
    document.getElementById('season-roi').textContent = `${seasonStats.roi > 0 ? '+' : ''}${seasonStats.roi}%`;
    
    // Show performance summary
    document.getElementById('performance-summary').style.display = 'flex';
  } catch (err) {
    console.error('Error updating performance stats:', err);
  }
}

function calculateStats(games) {
  let wins = 0;
  let losses = 0;
  let pushes = 0;
  
  games.forEach(game => {
    // Only count spread bets that were made
    if (game.spread_recommendation && game.spread_recommendation !== 'Pass') {
      if (game.spread_result === 'WIN') wins++;
      else if (game.spread_result === 'LOSS') losses++;
      else if (game.spread_result === 'PUSH') pushes++;
    }
  });
  
  const totalBets = wins + losses + pushes;
  const winRate = totalBets > 0 ? ((wins / (wins + losses)) * 100).toFixed(1) : '0.0';
  
  // ROI calculation: (wins * 0.91 - losses) / totalBets * 100
  // Assumes -110 odds (bet $100 to win $91)
  const roi = totalBets > 0 ? (((wins * 0.91 - losses) / totalBets) * 100).toFixed(1) : '0.0';
  
  return {
    wins,
    losses,
    pushes,
    totalBets,
    winRate,
    roi
  };
}

function getTeamIndicator(team) {
  if (!teamWinRates[team]) return '';
  
  const stats = teamWinRates[team];
  const winRate = stats.win_rate;
  let badgeClass = 'bg-secondary';
  let icon = '‚Äî';
  
  if (winRate === 100.0) {
    badgeClass = 'bg-success';
    icon = 'üî•';
  } else if (winRate >= 80.0) {
    badgeClass = 'bg-success';
    icon = '‚úì';
  } else if (winRate >= 60.0) {
    badgeClass = 'bg-blue';
    icon = '‚úì';
  } else if (winRate <= 20.0) {
    badgeClass = 'bg-warning';
    icon = '‚ö†';
  } else if (winRate === 0.0) {
    badgeClass = 'bg-danger';
    icon = '‚ùÑÔ∏è';
  }
  
  return `<span class="badge ${badgeClass} ms-1" title="${stats.record} (${stats.total} bets)">${icon} ${winRate.toFixed(0)}%</span>`;
}

function renderGames(games) {
  if (!games || games.length === 0) {
    document.getElementById('games-tbody').innerHTML = `
      <tr><td colspan="12" class="text-center text-muted">No games found</td></tr>
    `;
    return;
  }

  const isCompleted = games[0].is_completed;
  
  const html = games.map(game => {
    // Market implied scores (NO DECIMALS)
    const marketAwayScore = game.closing_away_score ? Math.round(game.closing_away_score) : '-';
    const marketHomeScore = game.closing_home_score ? Math.round(game.closing_home_score) : '-';
    const marketScore = `${marketAwayScore}-${marketHomeScore}`;
    
    // Our predicted scores - CALIBRATED (from isotonic/linear calibration, NOT market-centered)
    const ourAwayScore = game.our_away_score ? Math.round(game.our_away_score) : '-';
    const ourHomeScore = game.our_home_score ? Math.round(game.our_home_score) : '-';
    const ourScore = `${ourAwayScore}-${ourHomeScore}`;
    
    // Our RAW simulator scores (before market centering) - for debugging/understanding
    // Check for null/undefined explicitly (not just truthy, since 0 could be valid)
    const rawAwayScore = (game.our_away_score_raw !== null && game.our_away_score_raw !== undefined) ? Math.round(game.our_away_score_raw) : null;
    const rawHomeScore = (game.our_home_score_raw !== null && game.our_home_score_raw !== undefined) ? Math.round(game.our_home_score_raw) : null;
    const rawScore = (rawAwayScore !== null && rawHomeScore !== null) ? `${rawAwayScore}-${rawHomeScore}` : null;
    
    // Format spreads with FAVORITE perspective (WITH DECIMALS to preserve .5 values)
    // Display format: Always show FAVORITE with negative number
    // Backend spread convention: negative = away favored, positive = home favored
    let marketSpread = '-';
    let marketSpreadClass = '';
    if (game.closing_spread !== null && game.closing_spread !== undefined) {
      const marketSpreadValue = parseFloat(game.closing_spread);
      if (marketSpreadValue < 0) {
        // AWAY is favorite - show "AWAY -X" or "AWAY -X.5"
        marketSpread = `${game.away_team} ${marketSpreadValue.toFixed(1)}`;
        marketSpreadClass = 'text-danger';
      } else if (marketSpreadValue > 0) {
        // HOME is favorite - show "HOME -X" or "HOME -X.5"
        marketSpread = `${game.home_team} -${marketSpreadValue.toFixed(1)}`;
        marketSpreadClass = 'text-danger';
      } else {
        marketSpread = 'Pick\'em';
      }
    }
    
    // Calculate spread/total from CALIBRATED scores (what we actually use for betting)
    // Use calibrated scores (our_home_score, our_away_score) for display
    const calibratedSpread = ourAwayScore !== '-' && ourHomeScore !== '-' ? 
      (parseFloat(ourHomeScore) - parseFloat(ourAwayScore)) : null;
    const calibratedTotal = (ourAwayScore !== '-' && ourHomeScore !== '-') ? 
      (Number(ourHomeScore) + Number(ourAwayScore)) : null;
    const displaySpread = calibratedSpread !== null ? calibratedSpread : game.our_spread;
    const displayTotal = calibratedTotal !== null ? calibratedTotal : game.our_total;
    
    // Use decimals for our spread (preserve .5 values)
    let ourSpread = '-';
    let ourSpreadClass = '';
    if (displaySpread !== null && displaySpread !== undefined) {
      const ourSpreadValue = parseFloat(displaySpread);
      if (ourSpreadValue < 0) {
        // AWAY is favorite - show "AWAY -X" or "AWAY -X.5"
        ourSpread = `${game.away_team} ${ourSpreadValue.toFixed(1)}`;
        ourSpreadClass = 'text-primary';
      } else if (ourSpreadValue > 0) {
        // HOME is favorite - show "HOME -X" or "HOME -X.5"
        ourSpread = `${game.home_team} -${ourSpreadValue.toFixed(1)}`;
        ourSpreadClass = 'text-primary';
      } else {
        ourSpread = 'Pick\'em';
      }
    }
    
    // Use decimals for totals (preserve .5 values)
    const marketTotal = game.closing_total !== null && game.closing_total !== undefined ? 
      parseFloat(game.closing_total).toFixed(1) : '-';
    const ourTotal = displayTotal !== null && displayTotal !== undefined ? 
      parseFloat(displayTotal).toFixed(1) : '-';
    
    // Line movement (preserve decimals)
    const spreadMove = game.spread_movement && game.spread_movement !== 0 ? 
      `<div class="text-muted small">Open: ${game.opening_spread !== null && game.opening_spread !== undefined ? parseFloat(game.opening_spread).toFixed(1) : '-'} 
       <span class="text-${game.spread_movement > 0 ? 'success' : 'danger'}">
         ${game.spread_movement > 0 ? '‚Üë' : '‚Üì'}${Math.abs(game.spread_movement).toFixed(1)}
       </span></div>` : '';
    
    const totalMove = game.total_movement && game.total_movement !== 0 ? 
      `<div class="text-muted small">Open: ${game.opening_total !== null && game.opening_total !== undefined ? parseFloat(game.opening_total).toFixed(1) : '-'} 
       <span class="text-${game.total_movement > 0 ? 'success' : 'danger'}">
         ${game.total_movement > 0 ? '‚Üë' : '‚Üì'}${Math.abs(game.total_movement).toFixed(1)}
       </span></div>` : '';
    
    return `
    <tr>
      <td>
        <a href="/game/${game.away_team}/${game.home_team}/${game.week}" class="text-reset text-decoration-none">
          <div class="fw-bold">
            ${game.away_team}${getTeamIndicator(game.away_team)} @ ${game.home_team}${getTeamIndicator(game.home_team)}
          </div>
          ${game.game_date ? `<div class="text-muted small">${game.game_date}</div>` : ''}
        </a>
      </td>
      <td>
        ${game.final_score ? `<span class="fw-bold">${game.final_score}</span>` : '<span class="text-muted">-</span>'}
      </td>
      <td>
        <div class="small fw-bold">${marketScore}</div>
        <div class="text-muted" style="font-size: 0.7rem;">Market (from spread/total)</div>
      </td>
      <td>
        ${ourScore ? 
          `<div class="text-primary small fw-bold">${ourScore}</div>
           <div class="text-muted" style="font-size: 0.7rem;">Simulator Prediction (Calibrated)</div>
           ${rawScore && rawScore !== ourScore ?
             `<div class="text-muted" style="font-size: 0.65rem; margin-top: 2px; opacity: 0.7;">
               (Raw: ${rawScore})
             </div>` : ''}
          ` :
          `<div class="text-muted small">-</div>`}
        ${game.p_home_cover !== null && game.p_home_cover !== undefined ? 
          `<div class="text-muted" style="font-size: 0.7rem; margin-top: 2px;">
            <span class="badge ${game.p_away_cover > 0.524 ? 'bg-success' : 'bg-secondary'}" style="font-size: 0.65rem; padding: 2px 4px;" title="Probability ${game.away_team} covers the spread">
              ${game.away_team}: ${(game.p_away_cover * 100).toFixed(0)}%
            </span>
            <span class="badge ${game.p_home_cover > 0.524 ? 'bg-success' : 'bg-secondary'}" style="font-size: 0.65rem; padding: 2px 4px; margin-left: 2px;" title="Probability ${game.home_team} covers the spread">
              ${game.home_team}: ${(game.p_home_cover * 100).toFixed(0)}%
            </span>
          </div>` : ''}
      </td>
      <td>
        <div class="fw-bold ${marketSpreadClass}">${marketSpread}</div>
        ${spreadMove}
      </td>
      <td>
        <div class="fw-bold ${ourSpreadClass}">${ourSpread}</div>
      </td>
      <td>
        ${game.spread_recommendation && game.spread_recommendation !== 'Pass' ? 
          `<div class="fw-bold text-success" 
                data-bs-toggle="tooltip" 
                data-bs-placement="left"
                title="${generateSpreadTooltip(game)}"
                style="cursor: help;">
            ${game.spread_recommendation}
          </div>` : 
          `<span class="text-muted">Pass</span>`}
        ${game.spread_conviction ? 
          `<span class="badge ${game.spread_conviction_badge || 'bg-secondary'} mt-1"
                 data-bs-toggle="tooltip" 
                 data-bs-placement="top"
                 title="Conviction: ${game.spread_conviction} | Edge: ${(game.spread_edge_pct || 0).toFixed(1)}% | Hover bet text for details"
                 style="cursor: help;">
            ${game.spread_conviction}
          </span>` : ''}
        ${game.spread_rec_confidence ? `<div class="text-muted small mt-1">${(game.spread_rec_confidence * 100).toFixed(0)}%</div>` : ''}
        ${game.spread_recommendation && game.spread_recommendation !== 'Pass' ? 
          `<button class="btn btn-sm btn-outline-primary mt-2 w-100" onclick="explainBet('${game.away_team}', '${game.home_team}', ${game.week}, 'spread')" style="font-size: 0.7rem; padding: 2px 4px;">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="12" height="12" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 19a9 9 0 0 1 9 0a9 9 0 0 1 9 0" /><path d="M3 6a9 9 0 0 1 9 0a9 9 0 0 1 9 0" /><path d="M3 6l0 13" /><path d="M12 6l0 13" /><path d="M21 6l0 13" /></svg>
            Explain Why
          </button>` : ''}
      </td>
      <td>${renderResult(game.spread_result, game.on_right_side_spread, isCompleted)}</td>
      <td>
        <div class="fw-bold">${marketTotal}</div>
        ${totalMove}
      </td>
      <td>
        <div class="text-primary fw-bold">${ourTotal}</div>
        ${game.p_over !== null && game.p_over !== undefined ? 
          `<div class="text-muted small mt-1">
            <span class="badge ${game.p_over > 0.524 ? 'bg-success' : 'bg-secondary'}" style="font-size: 0.65rem; padding: 2px 4px;">
              Over: ${(game.p_over * 100).toFixed(0)}%
            </span>
            <span class="badge ${game.p_under > 0.524 ? 'bg-success' : 'bg-secondary'}" style="font-size: 0.65rem; padding: 2px 4px; margin-left: 2px;">
              Under: ${(game.p_under * 100).toFixed(0)}%
            </span>
          </div>` : ''}
      </td>
      <td>
        <div class="${game.total_recommendation && game.total_recommendation !== 'Pass' ? 'fw-bold' : 'text-muted'}">
          ${game.total_recommendation || 'Pass'}
        </div>
        ${game.total_conviction ? `<span class="badge ${game.total_conviction_badge || 'bg-secondary'}" title="Conviction: ${game.total_conviction} | Edge: ${game.total_edge_pct || 0}%">${game.total_conviction}</span>` : ''}
        ${game.total_rec_confidence ? `<div class="text-muted small mt-1">${(game.total_rec_confidence * 100).toFixed(0)}%</div>` : ''}
        ${game.total_std !== null && game.total_std !== undefined ? 
          `<div class="text-muted small mt-1" title="Distribution variance (higher = more volatile)">
            œÉ: ${game.total_std.toFixed(1)}
          </div>` : ''}
      </td>
      <td>${renderResult(game.total_result, game.on_right_side_total, isCompleted)}</td>
      <td>
        <div class="${game.moneyline_recommendation && game.moneyline_recommendation !== 'Pass' ? 'fw-bold' : 'text-muted'}">
          ${game.moneyline_recommendation || 'Pass'}
        </div>
        ${game.moneyline_rec_confidence ? `<div class="text-muted small">${(game.moneyline_rec_confidence * 100).toFixed(0)}%</div>` : ''}
      </td>
      <td>${renderResult(game.moneyline_result, null, isCompleted)}</td>
    </tr>
  `}).join('');

  document.getElementById('games-tbody').innerHTML = html;
  
  // Also render card view
  renderGamesCards(games);
  
  // Initialize Bootstrap tooltips after rendering
  const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
  tooltipTriggerList.forEach(tooltipTriggerEl => {
    new bootstrap.Tooltip(tooltipTriggerEl);
  });
}

function renderGamesCards(games) {
  if (!games || games.length === 0) {
    document.getElementById('games-cards').innerHTML = `
      <div class="text-center text-muted py-4">No games found</div>
    `;
    return;
  }

  const html = games.map(game => {
    const isCompleted = game.is_completed;
    
    // Market data
    const marketAwayScore = game.closing_away_score ? Math.round(game.closing_away_score) : '-';
    const marketHomeScore = game.closing_home_score ? Math.round(game.closing_home_score) : '-';
    const ourAwayScore = game.our_away_score ? Math.round(game.our_away_score) : '-';
    const ourHomeScore = game.our_home_score ? Math.round(game.our_home_score) : '-';
    
    // Calculate spreads and totals
    const calibratedSpread = ourAwayScore !== '-' && ourHomeScore !== '-' ? 
      (parseFloat(ourHomeScore) - parseFloat(ourAwayScore)) : null;
    const calibratedTotal = (ourAwayScore !== '-' && ourHomeScore !== '-') ? 
      (Number(ourHomeScore) + Number(ourAwayScore)) : null;
    const displaySpread = calibratedSpread !== null ? calibratedSpread : game.our_spread;
    const displayTotal = calibratedTotal !== null ? calibratedTotal : game.our_total;
    
    // Format spreads
    let marketSpread = '-';
    if (game.closing_spread !== null && game.closing_spread !== undefined) {
      const val = parseFloat(game.closing_spread);
      if (val < 0) marketSpread = `${game.away_team} ${val.toFixed(1)}`;
      else if (val > 0) marketSpread = `${game.home_team} -${val.toFixed(1)}`;
      else marketSpread = 'Pick\'em';
    }
    
    let ourSpread = '-';
    if (displaySpread !== null && displaySpread !== undefined) {
      const val = parseFloat(displaySpread);
      if (val < 0) ourSpread = `${game.away_team} ${val.toFixed(1)}`;
      else if (val > 0) ourSpread = `${game.home_team} -${val.toFixed(1)}`;
      else ourSpread = 'Pick\'em';
    }
    
    const marketTotal = game.closing_total !== null && game.closing_total !== undefined ? 
      parseFloat(game.closing_total).toFixed(1) : '-';
    const ourTotal = displayTotal !== null && displayTotal !== undefined ? 
      parseFloat(displayTotal).toFixed(1) : '-';
    
    // Result badges
    const spreadResultBadge = isCompleted && game.spread_result ? 
      `<span class="badge ${game.spread_result === 'WIN' ? 'bg-success' : game.spread_result === 'LOSS' ? 'bg-danger' : 'bg-secondary'}">${game.spread_result}</span>` : '';
    const totalResultBadge = isCompleted && game.total_result ? 
      `<span class="badge ${game.total_result === 'WIN' ? 'bg-success' : game.total_result === 'LOSS' ? 'bg-danger' : 'bg-secondary'}">${game.total_result}</span>` : '';
    const mlResultBadge = isCompleted && game.moneyline_result ? 
      `<span class="badge ${game.moneyline_result === 'WIN' ? 'bg-success' : game.moneyline_result === 'LOSS' ? 'bg-danger' : 'bg-secondary'}">${game.moneyline_result}</span>` : '';
    
    return `
      <div class="card mb-3">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-3">
              <a href="/game/${game.away_team}/${game.home_team}/${game.week}" class="text-reset text-decoration-none">
                <h3 class="mb-1">${game.away_team}${getTeamIndicator(game.away_team)} @ ${game.home_team}${getTeamIndicator(game.home_team)}</h3>
                <div class="text-muted">${game.game_date || ''}</div>
                ${game.final_score ? `<div class="h4 mb-0 mt-2">Final: ${game.final_score}</div>` : ''}
              </a>
            </div>
            <div class="col-md-9">
              <div class="row g-2">
                <!-- Spread -->
                <div class="col-md-4">
                  <div class="card card-sm">
                    <div class="card-body">
                      <div class="row align-items-center">
                        <div class="col-auto">
                          <span class="bg-primary text-white avatar">
                            <i class="ti ti-trending-up"></i>
                          </span>
                        </div>
                        <div class="col">
                          <div class="font-weight-medium">Spread</div>
                          <div class="text-muted small">
                            Market: ${marketSpread}
                          </div>
                          <div class="text-primary small">
                            Our Line: ${ourSpread}
                          </div>
                          ${game.spread_recommendation && game.spread_recommendation !== 'Pass' ? 
                            `<div class="mt-2">
                              <span class="badge bg-success">${game.spread_recommendation}</span>
                              ${game.spread_conviction ? `<span class="badge ${game.spread_conviction_badge || 'bg-secondary'} ms-1">${game.spread_conviction}</span>` : ''}
                              ${spreadResultBadge ? `<span class="ms-1">${spreadResultBadge}</span>` : ''}
                            </div>` : 
                            `<div class="text-muted small mt-2">Pass</div>`}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Total -->
                <div class="col-md-4">
                  <div class="card card-sm">
                    <div class="card-body">
                      <div class="row align-items-center">
                        <div class="col-auto">
                          <span class="bg-info text-white avatar">
                            <i class="ti ti-chart-line"></i>
                          </span>
                        </div>
                        <div class="col">
                          <div class="font-weight-medium">Total</div>
                          <div class="text-muted small">
                            Market: ${marketTotal}
                          </div>
                          <div class="text-primary small">
                            Our Projection: ${ourTotal}
                          </div>
                          ${game.total_recommendation && game.total_recommendation !== 'Pass' ? 
                            `<div class="mt-2">
                              <span class="badge bg-info">${game.total_recommendation}</span>
                              ${game.total_conviction ? `<span class="badge ${game.total_conviction_badge || 'bg-secondary'} ms-1">${game.total_conviction}</span>` : ''}
                              ${totalResultBadge ? `<span class="ms-1">${totalResultBadge}</span>` : ''}
                            </div>` : 
                            `<div class="text-muted small mt-2">Pass</div>`}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Moneyline -->
                <div class="col-md-4">
                  <div class="card card-sm">
                    <div class="card-body">
                      <div class="row align-items-center">
                        <div class="col-auto">
                          <span class="bg-success text-white avatar">
                            <i class="ti ti-currency-dollar"></i>
                          </span>
                        </div>
                        <div class="col">
                          <div class="font-weight-medium">Moneyline</div>
                          <div class="text-muted small">
                            Market: ${marketAwayScore}-${marketHomeScore}
                          </div>
                          <div class="text-primary small">
                            Our Projection: ${ourAwayScore}-${ourHomeScore}
                          </div>
                          ${game.moneyline_recommendation && game.moneyline_recommendation !== 'Pass' ? 
                            `<div class="mt-2">
                              <span class="badge bg-primary">${game.moneyline_recommendation}</span>
                              ${mlResultBadge ? `<span class="ms-1">${mlResultBadge}</span>` : ''}
                            </div>` : 
                            `<div class="text-muted small mt-2">Pass</div>`}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');

  document.getElementById('games-cards').innerHTML = html;
}

// View toggle functionality
document.addEventListener('DOMContentLoaded', function() {
  const viewCardsRadio = document.getElementById('view-cards');
  const viewTableRadio = document.getElementById('view-table');
  
  if (viewCardsRadio) {
    viewCardsRadio.addEventListener('change', function() {
      if (this.checked) {
        document.getElementById('games-cards').classList.remove('d-none');
        document.getElementById('games-table-view').classList.add('d-none');
      }
    });
  }
  
  if (viewTableRadio) {
    viewTableRadio.addEventListener('change', function() {
      if (this.checked) {
        document.getElementById('games-cards').classList.add('d-none');
        document.getElementById('games-table-view').classList.remove('d-none');
      }
    });
  }
});

// Sorting state and functions (minimal client-side logic)
let currentGamesData = [];
let currentSortColumn = null;
let currentSortDirection = 'asc';
let teamWinRates = {}; // Global storage for team performance indicators

function setupTableSorting() {
  document.querySelectorAll('#games-table th.sortable').forEach(th => {
    th.addEventListener('click', function() {
      const sortKey = this.getAttribute('data-sort');
      
      // Toggle direction if clicking same column
      if (currentSortColumn === sortKey) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        currentSortColumn = sortKey;
        currentSortDirection = 'asc';
      }
      
      // Update header UI
      document.querySelectorAll('#games-table th.sortable').forEach(header => {
        header.classList.remove('sort-asc', 'sort-desc');
      });
      this.classList.add(`sort-${currentSortDirection}`);
      
      // Sort data array
      sortGamesData(sortKey, currentSortDirection);
      
      // Re-render with sorted data
      renderGames(currentGamesData);
    });
  });
}

function sortGamesData(sortKey, direction) {
  currentGamesData.sort((a, b) => {
    let aVal, bVal;
    
    // Extract values based on sort key
    switch(sortKey) {
      case 'game':
        aVal = `${a.away_team} @ ${a.home_team}`;
        bVal = `${b.away_team} @ ${b.home_team}`;
        break;
      case 'final':
        aVal = a.final_score || '';
        bVal = b.final_score || '';
        break;
      case 'market_score':
        aVal = (a.closing_away_score || 0) + (a.closing_home_score || 0);
        bVal = (b.closing_away_score || 0) + (b.closing_home_score || 0);
        break;
      case 'our_score':
        aVal = (a.our_away_score || 0) + (a.our_home_score || 0);
        bVal = (b.our_away_score || 0) + (b.our_home_score || 0);
        break;
      case 'market_spread':
        aVal = Math.abs(a.closing_spread || 0);
        bVal = Math.abs(b.closing_spread || 0);
        break;
      case 'our_spread':
        aVal = Math.abs(a.our_spread || 0);
        bVal = Math.abs(b.our_spread || 0);
        break;
      case 'spread_bet':
        aVal = a.spread_recommendation || 'Pass';
        bVal = b.spread_recommendation || 'Pass';
        break;
      case 'spread_result':
        aVal = a.spread_result || '';
        bVal = b.spread_result || '';
        break;
      case 'market_total':
        aVal = a.closing_total || 0;
        bVal = b.closing_total || 0;
        break;
      case 'our_total':
        aVal = a.our_total || 0;
        bVal = b.our_total || 0;
        break;
      case 'total_bet':
        aVal = a.total_recommendation || 'Pass';
        bVal = b.total_recommendation || 'Pass';
        break;
      case 'total_result':
        aVal = a.total_result || '';
        bVal = b.total_result || '';
        break;
      case 'ml_bet':
        aVal = a.moneyline_recommendation || 'Pass';
        bVal = b.moneyline_recommendation || 'Pass';
        break;
      case 'ml_result':
        aVal = a.moneyline_result || '';
        bVal = b.moneyline_result || '';
        break;
      default:
        aVal = '';
        bVal = '';
    }
    
    // Compare values
    if (typeof aVal === 'number' && typeof bVal === 'number') {
      return direction === 'asc' ? aVal - bVal : bVal - aVal;
    } else {
      const strA = String(aVal).toLowerCase();
      const strB = String(bVal).toLowerCase();
      if (direction === 'asc') {
        return strA < strB ? -1 : strA > strB ? 1 : 0;
      } else {
        return strB < strA ? -1 : strB > strA ? 1 : 0;
      }
    }
  });
}

function renderResult(result, onRightSide, isCompleted) {
  if (isCompleted && result) {
    if (result === 'WIN') return '<span class="badge bg-success">W</span>';
    if (result === 'LOSS') return '<span class="badge bg-danger">L</span>';
    return '<span class="text-muted">-</span>';
  } else if (onRightSide !== null && onRightSide !== undefined) {
    return onRightSide ? 
      '<span class="badge bg-success-lt">Sharp ‚úì</span>' : 
      '<span class="badge bg-danger-lt">Fade ‚úó</span>';
  }
  return '<span class="text-muted">-</span>';
}

document.getElementById('weekSelect').addEventListener('change', loadGames);
document.addEventListener('DOMContentLoaded', loadGames);

// Script runner
async function runScript(scriptName) {
  const outputDiv = document.getElementById('script-output');
  const statusEl = document.getElementById('script-status');
  const messageEl = document.getElementById('script-message');
  const btnIdMap = {
    'ol_continuity': 'ol',
    'dl_pressure': 'dl',
    'matchup_stress': 'stress',
    'predictions': 'predictions',
    'future_stress': 'future',
    'sim_backtest': 'sim-backtest',
    'sim_week9_10': 'sim-week9-10',
    'sim_format': 'sim-format',
    'sim_all': 'sim-all'
  };
  const btnId = `btn-${btnIdMap[scriptName] || scriptName}`;
  const btn = document.getElementById(btnId);
  
  // Show loading state
  outputDiv.style.display = 'block';
  outputDiv.querySelector('.alert').className = 'alert alert-info mb-0';
  statusEl.textContent = 'Running...';
  messageEl.textContent = 'Please wait...';
  btn.disabled = true;
  
  try {
    const res = await fetch(`/api/run-script/${scriptName}`, {
      method: 'POST'
    });
    
    const data = await res.json();
    
    if (data.success) {
      outputDiv.querySelector('.alert').className = 'alert alert-success mb-0';
      outputDiv.querySelector('.spinner-border').style.display = 'none';
      statusEl.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-check me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l5 5l10 -10" /></svg>Success!';
      messageEl.textContent = data.message;
      
      // Reload games after predictions update
      if (scriptName === 'predictions' || scriptName.startsWith('sim_')) {
        setTimeout(() => {
          loadGames();
        }, 1000);
      }
    } else {
      throw new Error(data.error || 'Unknown error');
    }
  } catch (err) {
    outputDiv.querySelector('.alert').className = 'alert alert-danger mb-0';
    outputDiv.querySelector('.spinner-border').style.display = 'none';
    statusEl.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-alert-circle me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0" /><path d="M12 8v4" /><path d="M12 16h.01" /></svg>Error';
    messageEl.textContent = err.message;
  } finally {
    btn.disabled = false;
  }
}

// Generate rich tooltip for spread bets
function generateSpreadTooltip(game) {
  if (!game.spread_recommendation || game.spread_recommendation === 'Pass') {
    return 'No bet recommended - probability too close to 50%';
  }
  
  const betTeam = game.spread_recommendation.replace(' ATS', '').trim();
  const marketLine = parseFloat(game.closing_spread);
  const prob = game.spread_recommendation.includes(game.home_team) ? 
    (game.p_home_cover * 100).toFixed(1) : 
    (game.p_away_cover * 100).toFixed(1);
  const edge = (game.spread_edge_pct || 0).toFixed(1);
  const rawHome = game.our_home_score_raw ? Math.round(game.our_home_score_raw) : '?';
  const rawAway = game.our_away_score_raw ? Math.round(game.our_away_score_raw) : '?';
  const calHome = game.our_home_score ? Math.round(game.our_home_score) : '?';
  const calAway = game.our_away_score ? Math.round(game.our_away_score) : '?';
  const variance = game.spread_std ? game.spread_std.toFixed(1) : '?';
  
  // Plain text tooltip without HTML to avoid quote escaping issues
  return `BET: ${betTeam} to cover (${prob}% confidence, +${edge}% edge)\n\n` +
         `Raw Sims: ${rawAway}-${rawHome}\n` +
         `Calibrated: ${calAway}-${calHome}\n` +
         `Variance: œÉ = ${variance} pts\n` +
         `Market Line: ${marketLine.toFixed(1)}\n\n` +
         `Click for detailed explanation...`;
}

// Explain bet using LLM
async function explainBet(awayTeam, homeTeam, week, betType) {
  const modal = document.createElement('div');
  modal.className = 'modal fade';
  modal.innerHTML = `
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 19a9 9 0 0 1 9 0a9 9 0 0 1 9 0" /><path d="M3 6a9 9 0 0 1 9 0a9 9 0 0 1 9 0" /><path d="M3 6l0 13" /><path d="M12 6l0 13" /><path d="M21 6l0 13" /></svg>
            Bet Explanation: ${awayTeam} @ ${homeTeam} Week ${week}
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Generating detailed explanation...</p>
          </div>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  const modalInstance = new bootstrap.Modal(modal);
  modalInstance.show();
  
  try {
    const response = await fetch('/api/explain-bet', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ awayTeam, homeTeam, week, betType })
    });
    
    const data = await response.json();
    
    if (data.success) {
      modal.querySelector('.modal-body').innerHTML = `
        <div class="explanation-content">
          ${data.explanation}
        </div>
      `;
    } else {
      throw new Error(data.error || 'Failed to generate explanation');
    }
  } catch (err) {
    modal.querySelector('.modal-body').innerHTML = `
      <div class="alert alert-danger">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9" /><path d="M12 8v4" /><path d="M12 16h.01" /></svg>
        Error: ${err.message}
      </div>
    `;
  }
  
  modal.addEventListener('hidden.bs.modal', () => {
    modal.remove();
  });
}

// Reload data function
        async function runWeeklyDataPrep() {
          const btn = document.getElementById('btn-weekly-prep');
          const output = document.getElementById('script-output');
          const status = document.getElementById('script-status');
          const message = document.getElementById('script-message');
          
          btn.disabled = true;
          btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating Data...';
          output.style.display = 'block';
          status.textContent = 'Running weekly data prep...';
          message.textContent = 'Updating NFLverse stats and calibration (2-3 min)';
          
          try {
            const res = await fetch('/api/run-weekly-prep', {
              method: 'POST'
            });
            
            const data = await res.json();
            
            if (data.success) {
              status.textContent = '‚úÖ Complete!';
              message.textContent = data.message;
              btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-database-import me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 6m-8 0a8 3 0 1 0 16 0a8 3 0 1 0 -16 0" /><path d="M4 6v6a8 3 0 0 0 8 3" /><path d="M4 12v6a8 3 0 0 0 8 3" /><path d="M19 15v-2" /><path d="M19 21l3 -3l-3 -3" /><path d="M22 18h-9" /></svg>Weekly Data Prep`;
              btn.disabled = false;
              setTimeout(() => output.style.display = 'none', 5000);
            } else {
              status.textContent = '‚ùå Failed';
              message.textContent = data.error;
              btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-database-import me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 6m-8 0a8 3 0 1 0 16 0a8 3 0 1 0 -16 0" /><path d="M4 6v6a8 3 0 0 0 8 3" /><path d="M4 12v6a8 3 0 0 0 8 3" /><path d="M19 15v-2" /><path d="M19 21l3 -3l-3 -3" /><path d="M22 18h-9" /></svg>Weekly Data Prep`;
              btn.disabled = false;
            }
          } catch (error) {
            status.textContent = '‚ùå Error';
            message.textContent = error.message;
            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-database-import me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 6m-8 0a8 3 0 1 0 16 0a8 3 0 1 0 -16 0" /><path d="M4 6v6a8 3 0 0 0 8 3" /><path d="M4 12v6a8 3 0 0 0 8 3" /><path d="M19 15v-2" /><path d="M19 21l3 -3l-3 -3" /><path d="M22 18h-9" /></svg>Weekly Data Prep`;
            btn.disabled = false;
          }
        }

        async function fetchLiveScores() {
          const btn = document.getElementById('btn-fetch-scores');
          btn.disabled = true;
          btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Fetching ESPN...';
          
          try {
            const res = await fetch('/api/fetch-live-scores', {
              method: 'POST'
            });
            
            const data = await res.json();
            
            if (data.success) {
              // Show success message
              btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-check me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l5 5l10 -10" /></svg>${data.message}`;
              btn.classList.remove('btn-warning');
              btn.classList.add('btn-success');
              
              // Reload the current view to show updated scores
              await loadGames();
              
              // Reset button after 3 seconds
              setTimeout(() => {
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-live-photo me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r=".5" fill="currentColor" /><circle cx="12" cy="12" r="7" /><path d="M8 8l-2.5 -2.5" /><path d="M16 8l2.5 -2.5" /><path d="M8 16l-2.5 2.5" /><path d="M16 16l2.5 2.5" /></svg>Fetch Live Scores`;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-warning');
                btn.disabled = false;
              }, 3000);
            } else {
              throw new Error(data.error || 'Failed to fetch scores');
            }
          } catch (err) {
            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-alert-circle me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0" /><path d="M12 8v4" /><path d="M12 16h.01" /></svg>Error`;
            btn.classList.remove('btn-warning');
            btn.classList.add('btn-danger');
            alert(`Error: ${err.message}`);
            
            setTimeout(() => {
              btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-live-photo me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r=".5" fill="currentColor" /><circle cx="12" cy="12" r="7" /><path d="M8 8l-2.5 -2.5" /><path d="M16 8l2.5 -2.5" /><path d="M8 16l-2.5 2.5" /><path d="M16 16l2.5 2.5" /></svg>Fetch Live Scores`;
              btn.classList.remove('btn-danger');
              btn.classList.add('btn-warning');
              btn.disabled = false;
            }, 3000);
          }
        }
        
        async function reloadData() {
          const btn = document.getElementById('btn-reload');
          btn.disabled = true;
          btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Reloading...';
          
          try {
            const res = await fetch('/api/reload-data', {
              method: 'POST'
            });
            
            const data = await res.json();
            
            if (data.success) {
              // Show success message
              btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-check me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l5 5l10 -10" /></svg>Reloaded!`;
              btn.classList.remove('btn-info');
              btn.classList.add('btn-success');
              
              // Reload the current view
              await loadGames();
              
              // Reset button after 2 seconds
              setTimeout(() => {
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-refresh me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4" /><path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4" /></svg>Reload Data`;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-info');
                btn.disabled = false;
              }, 2000);
            } else {
              throw new Error(data.error || 'Failed to reload data');
            }
          } catch (err) {
            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-alert-circle me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0" /><path d="M12 8v4" /><path d="M12 16h.01" /></svg>Error`;
            btn.classList.remove('btn-info');
            btn.classList.add('btn-danger');
            alert(`Error: ${err.message}`);
            
            setTimeout(() => {
              btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-refresh me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4" /><path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4" /></svg>Reload Data`;
              btn.classList.remove('btn-danger');
              btn.classList.add('btn-info');
              btn.disabled = false;
            }, 2000);
  }
}

// AI Picks Functions
async function generateAIPicks() {
  const btn = document.getElementById('btn-generate-picks');
  const loadingDiv = document.getElementById('ai-picks-loading');
  const contentDiv = document.getElementById('ai-picks-content');
  
  btn.disabled = true;
  loadingDiv.style.display = 'block';
  contentDiv.style.opacity = '0.5';
  
  try {
    const week = document.getElementById('weekSelect').value;
    const response = await fetch(`/api/generate-ai-picks?week=${week}`, {
      method: 'POST'
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    
    if (data.error) {
      throw new Error(data.error);
    }
    
    // Display the picks
    displayAIPicks(data);
    
  } catch (err) {
    alert(`Error generating AI picks: ${err.message}\n\nMake sure:\n1. OpenAI API key is set (OPENAI_API_KEY env variable)\n2. Predictions have been generated for this week\n3. openai package is installed (pip install openai)`);
  } finally {
    btn.disabled = false;
    loadingDiv.style.display = 'none';
    contentDiv.style.opacity = '1';
  }
}

async function loadAIPicks() {
  const week = document.getElementById('weekSelect').value;
  
  try {
    const response = await fetch(`/api/ai-picks?week=${week}`);
    
    if (!response.ok) {
      return;
    }
    
    const data = await response.json();
    
    if (data && !data.error) {
      displayAIPicks(data);
      document.getElementById('ai-picks-section').style.display = 'block';
    }
  } catch (err) {
    console.log('No AI picks found for this week');
  }
}

function displayAIPicks(data) {
  document.getElementById('ai-week-num').textContent = data.week || '';
  document.getElementById('ai-picks-section').style.display = 'block';
  
  const rawResponse = data.raw_response || '';
  const lines = rawResponse.split('\n');
  let currentSection = null;
  const tables = {
    ats: [],
    totals: [],
    moneyline: [],
    final: []
  };
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();
    
    if (line.match(/Against-the-Spread|ATS Bets/i)) {
      currentSection = 'ats';
      continue;
    } else if (line.match(/Totals|Over\/Under/i)) {
      currentSection = 'totals';
      continue;
    } else if (line.match(/Moneyline/i)) {
      currentSection = 'moneyline';
      continue;
    } else if (line.match(/Final Recommendations|Top Picks/i)) {
      currentSection = 'final';
      continue;
    }
    
    if (line && line.includes('|') && currentSection && currentSection !== 'final') {
      if (line.match(/^[\|\s\-:]+$/)) continue;
      const cells = line.split('|').map(c => c.trim()).filter(c => c);
      if (cells[0] && cells[0].match(/Game|Prediction/i)) continue;
      if (cells.length >= 4) {
        tables[currentSection].push(cells);
      }
    } else if (line && currentSection === 'final') {
      tables.final.push(line);
    }
  }
  
  const atsBody = document.getElementById('ai-ats-body');
  if (tables.ats.length > 0) {
    atsBody.innerHTML = tables.ats.map(cells => `<tr>${cells.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('');
  } else {
    atsBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No ATS plays recommended</td></tr>';
  }
  
  const totalsBody = document.getElementById('ai-totals-body');
  if (tables.totals.length > 0) {
    totalsBody.innerHTML = tables.totals.map(cells => `<tr>${cells.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('');
  } else {
    totalsBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No total plays recommended</td></tr>';
  }
  
  const mlBody = document.getElementById('ai-ml-body');
  if (tables.moneyline.length > 0) {
    mlBody.innerHTML = tables.moneyline.map(cells => `<tr>${cells.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('');
  } else {
    mlBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No moneyline plays recommended</td></tr>';
  }
  
  const finalRecs = document.getElementById('ai-final-recs');
  const finalContent = document.getElementById('ai-final-content');
  if (tables.final.length > 0) {
    finalContent.innerHTML = tables.final.filter(line => line).map(line => {
      if (line.startsWith('**') || line.startsWith('#')) {
        return `<p><strong>${line.replace(/[\*#]/g, '')}</strong></p>`;
      } else if (line.startsWith('-')) {
        return `<li>${line.substring(1).trim()}</li>`;
      } else {
        return `<p>${line}</p>`;
      }
    }).join('');
    finalRecs.style.display = 'block';
  } else {
    finalRecs.style.display = 'none';
  }
}
</script>

{% endblock %}

