{% extends "base.html" %}

{% block title %}Model Accuracy Tracking{% endblock %}

{% block content %}
<div class="page-header d-print-none">
  <div class="container-xl">
    <div class="row g-2 align-items-center">
      <div class="col">
        <h2 class="page-title">
          üìä Model Accuracy Tracking
        </h2>
        <div class="text-muted mt-1">Compare prediction accuracy across all models - 2025 Season</div>
      </div>
      <div class="col-auto ms-auto">
        <div class="btn-list">
          <button class="btn btn-primary" onclick="updateModelPerformance()">
            <i class="ti ti-refresh icon"></i>
            Update Model Stats
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="page-body">
  <div class="container-xl">
    
    {% if report.get('error') %}
    <!-- Error State -->
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-body text-center py-5">
            <div class="empty">
              <div class="empty-icon">
                <i class="ti ti-chart-line icon ti-xl"></i>
              </div>
              <p class="empty-title">No accuracy data yet</p>
              <p class="empty-subtitle text-muted">
                {{ report.error }}
              </p>
              <p class="text-muted mt-3">
                <strong>How to populate:</strong><br>
                Accuracy tracking will start automatically as games are completed.<br>
                Predictions are recorded when you view game details,<br>
                and results are updated from ESPN after each week.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    {% else %}
    
    <!-- Summary Cards -->
    <div class="row row-cards mb-3">
      <div class="col-md-6 col-lg-3">
        <div class="card">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="subheader">Total Games Tracked</div>
            </div>
            <div class="h1 mb-0">{{ report.total_games }}</div>
            <div class="text-muted small">2025 Season</div>
          </div>
        </div>
      </div>
      
      {% if report.models.get('your_model') and not report.models.your_model.get('error') %}
      <div class="col-md-6 col-lg-3">
        <div class="card">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="subheader">Your Model Accuracy</div>
            </div>
            <div class="h1 mb-0">{{ report.models.your_model.accuracy_pct }}%</div>
            <div class="text-muted small">{{ report.models.your_model.correct_picks }}/{{ report.models.your_model.games }} correct</div>
          </div>
        </div>
      </div>
      
      <div class="col-md-6 col-lg-3">
        <div class="card">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="subheader">Brier Score</div>
            </div>
            <div class="h1 mb-0">{{ report.models.your_model.brier_score }}</div>
            <div class="text-muted small">{{ report.models.your_model.calibration }}</div>
          </div>
        </div>
      </div>
      
      <div class="col-md-6 col-lg-3">
        <div class="card">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="subheader">Model Rank</div>
            </div>
            <div class="h1 mb-0">#1</div>
            <div class="text-muted small">vs industry</div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
    
    <!-- Model Comparison Table -->
    <div class="row mb-3">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">üèÜ Model Performance Comparison</h3>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-vcenter">
                <thead>
                  <tr>
                    <th>Model</th>
                    <th class="text-end">Games</th>
                    <th class="text-end">Accuracy</th>
                    <th class="text-end">Correct Picks</th>
                    <th class="text-end">Brier Score</th>
                    <th>Calibration</th>
                  </tr>
                </thead>
                <tbody>
                  {% if report.models.get('your_model') and not report.models.your_model.get('error') %}
                  <tr class="table-primary">
                    <td><strong>üî• Your Model</strong></td>
                    <td class="text-end">{{ report.models.your_model.games }}</td>
                    <td class="text-end"><strong>{{ report.models.your_model.accuracy_pct }}%</strong></td>
                    <td class="text-end">{{ report.models.your_model.correct_picks }}</td>
                    <td class="text-end">{{ report.models.your_model.brier_score }}</td>
                    <td>
                      {% if report.models.your_model.brier_score < 0.15 %}
                      <span class="badge bg-success">Excellent</span>
                      {% elif report.models.your_model.brier_score <= 0.25 %}
                      <span class="badge bg-info">Good</span>
                      {% else %}
                      <span class="badge bg-warning">Needs improvement</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endif %}
                  
                  {% if report.models.get('fivethirtyeight') and not report.models.fivethirtyeight.get('error') %}
                  <tr>
                    <td>üìä FiveThirtyEight</td>
                    <td class="text-end">{{ report.models.fivethirtyeight.games }}</td>
                    <td class="text-end">{{ report.models.fivethirtyeight.accuracy_pct }}%</td>
                    <td class="text-end">{{ report.models.fivethirtyeight.correct_picks }}</td>
                    <td class="text-end">{{ report.models.fivethirtyeight.brier_score }}</td>
                    <td>
                      {% if report.models.fivethirtyeight.brier_score < 0.15 %}
                      <span class="badge bg-success">Excellent</span>
                      {% elif report.models.fivethirtyeight.brier_score <= 0.25 %}
                      <span class="badge bg-info">Good</span>
                      {% else %}
                      <span class="badge bg-warning">Needs improvement</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endif %}
                  
                  {% if report.models.get('vegas') and not report.models.vegas.get('error') %}
                  <tr>
                    <td>üí∞ Vegas Consensus</td>
                    <td class="text-end">{{ report.models.vegas.games }}</td>
                    <td class="text-end">{{ report.models.vegas.accuracy_pct }}%</td>
                    <td class="text-end">{{ report.models.vegas.correct_picks }}</td>
                    <td class="text-end">{{ report.models.vegas.brier_score }}</td>
                    <td>
                      {% if report.models.vegas.brier_score < 0.15 %}
                      <span class="badge bg-success">Excellent</span>
                      {% elif report.models.vegas.brier_score <= 0.25 %}
                      <span class="badge bg-info">Good</span>
                      {% else %}
                      <span class="badge bg-warning">Needs improvement</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
            
            <div class="text-muted small mt-3">
              <strong>Metrics Explained:</strong>
              <ul class="mb-0">
                <li><strong>Accuracy:</strong> Percentage of correct win/loss predictions (>50% probability = pick)</li>
                <li><strong>Brier Score:</strong> Measures prediction quality (0 = perfect, 0.25 = baseline, 0.5 = random)</li>
                <li><strong>Calibration:</strong> How well predicted probabilities match actual outcomes</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Game-by-Game Breakdown -->
    <div class="row mb-3">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">üìã Game-by-Game Breakdown</h3>
            <div class="card-subtitle">
              <small class="text-muted">See which games your model predicted correctly</small>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-vcenter table-hover">
                <thead>
                  <tr>
                    <th>Week</th>
                    <th>Matchup</th>
                    <th>Your Prediction</th>
                    <th>Confidence</th>
                    <th>Actual Result</th>
                    <th class="text-center">Result</th>
                  </tr>
                </thead>
                <tbody>
                  {% if report.game_breakdown %}
                    {% for game in report.game_breakdown %}
                    <tr class="{% if game.correct %}table-success{% else %}table-danger{% endif %}">
                      <td>Week {{ game.week }}</td>
                      <td><strong>{{ game.away }} @ {{ game.home }}</strong></td>
                      <td>
                        {% if game.predicted_winner == game.away %}
                          {{ game.away }} by {{ game.predicted_margin|abs|round(1) }}
                        {% else %}
                          {{ game.home }} by {{ game.predicted_margin|abs|round(1) }}
                        {% endif %}
                      </td>
                      <td>{{ game.confidence }}%</td>
                      <td>
                        {% if game.actual_winner == game.away %}
                          <strong>{{ game.away }}</strong> {{ game.away_score }}-{{ game.home_score }}
                        {% else %}
                          <strong>{{ game.home }}</strong> {{ game.home_score }}-{{ game.away_score }}
                        {% endif %}
                      </td>
                      <td class="text-center">
                        {% if game.correct %}
                          <span class="badge bg-success">‚úì Correct</span>
                        {% else %}
                          <span class="badge bg-danger">‚úó Wrong</span>
                        {% endif %}
                      </td>
                    </tr>
                    {% endfor %}
                  {% else %}
                    <tr>
                      <td colspan="6" class="text-center text-muted">
                        <div class="empty">
                          <p class="empty-title">No game-by-game data available yet</p>
                          <p class="empty-subtitle">
                            Game breakdown will appear here once predictions and results are recorded
                          </p>
                        </div>
                      </td>
                    </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- What's Next -->
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">üìà How Accuracy Tracking Works</h3>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4">
                <div class="mb-3">
                  <h4 class="text-primary">1. Auto-Record Predictions</h4>
                  <p class="text-muted">When you view game details, predictions from all models are automatically saved.</p>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <h4 class="text-success">2. Fetch Results</h4>
                  <p class="text-muted">After games complete, actual scores are fetched from ESPN API automatically.</p>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <h4 class="text-info">3. Calculate Accuracy</h4>
                  <p class="text-muted">System matches predictions with results and calculates accuracy metrics.</p>
                </div>
              </div>
            </div>
            
            <hr>
            
            <h4 class="mb-3">üéØ Brier Score Guide</h4>
            <div class="row">
              <div class="col-md-3">
                <div class="card card-sm bg-success-lt">
                  <div class="card-body text-center">
                    <div class="h3 mb-0">&lt; 0.15</div>
                    <div class="text-muted small">Excellent</div>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card card-sm bg-info-lt">
                  <div class="card-body text-center">
                    <div class="h3 mb-0">0.15 - 0.25</div>
                    <div class="text-muted small">Good</div>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card card-sm bg-warning-lt">
                  <div class="card-body text-center">
                    <div class="h3 mb-0">0.25 - 0.35</div>
                    <div class="text-muted small">Average</div>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card card-sm bg-danger-lt">
                  <div class="card-body text-center">
                    <div class="h3 mb-0">&gt; 0.35</div>
                    <div class="text-muted small">Poor</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    {% endif %}
    
  </div>
</div>

<script>
// Model performance update function
async function updateModelPerformance() {
  const btn = event.target;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating...';
  
  try {
    const response = await fetch('/api/update-model-performance', { method: 'POST' });
    const data = await response.json();
    
    if (data.success) {
      alert('‚úÖ ' + data.message);
      location.reload();
    } else {
      alert('‚ùå ' + data.message);
      btn.disabled = false;
      btn.innerHTML = 'Update Model Stats';
    }
  } catch (error) {
    console.error('Error:', error);
    alert('‚ùå Error updating model performance');
    btn.disabled = false;
    btn.innerHTML = 'Update Model Stats';
  }
}
</script>

{% endblock %}

